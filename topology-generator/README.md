# Topology Generator

The generator creates a topology based on different instances of the same application called Mimik. 

Basically what Mimik does is to imitate a service that listens to certain paths and methods, and connects these with upstream connections (that usually are Mimik instances too) forming a service mesh.

The topology is generated based on some parameters like:

* Number of namespaces
* Number of services per namespace
* Number of connections between services in the same namespace
* Number of random connections between services in different namespaces

## Platform Install

This demo has been tested using [Minikube](https://istio.io/latest/docs/setup/platform-setup/minikube/) and [Istio 1.12](https://istio.io/latest/docs/setup/getting-started/#install).

## Application Install

Create the application resources:

```bash
kubectl create ns topology-generator
kubectl apply -n topology-generator -f https://raw.githubusercontent.com/kiali/demos/master/topology-generator/deploy/generator.yaml 
```

## Demo Design

This demo exposes a web application where with some parameters, a command is produced to be executed in the terminal against any cluster:

![generator](./doc/generator.png)

Visit the application through a proxy:

```bash
kubectl port-forward svc/topology-generator 8080:8080 -n topology-generator
```

Configure the parameters, click on "Generate", copy the command and execute it in a terminal.

As a result, the topology will be created to be observed and managed by Kiali:

![kiali](./doc/kiali.png)

## Cleanup

Delete all namespaces generated by the application:

```bash
kubectl delete ns --selector=generated-by=mimik
```

Delete the topology generator:

```bash
kubectl delete ns topology-generator
```

## CLI Install

Generator `deploy.json` locally with Command Line:

```shell

git clone https://github.com/kiali/demos.git

cd demos/topology-generator

make build-generator

```

Add generator binary to your PATH

## CLI Usage

### CLI Mode

Run in CLI Mode:

``` shell
generator -m l
```

#### Configure CLI Generate Options

Configure Generated Namespaces, Services, Connections, RandomConnections:

For example:

Generate namespaces = 3, services = 4, connections = 10, random connections = 8":

``` shell
generator -m l -n 3 -s 4 -c 10 -r 8
```

### Server Mode

Run in Server Mode:

``` shell
generator -m s

# Server mode is the default mode, you can just run generator directly.

generator
```

### Configure Deployment Settings

> deployment settings are both supported in `server mode` and `cli mode`

Configure Injection Labels like `istio.io/rev:1-10-3`:

> Injection Label like `istio.io/rev:1-10-3` is used in canary release of istio.
> 1-10-3 means the version which istio is running.

``` shell
generator -injectionlabel "istio.io/rev:1-10-3"
```

Configure instance `image tag name` and `version`:

``` shell
generator -image "quay.io/leandroberetta/mimik" -version "v0.0.2"
```

Configure Istio-Proxy Request CPU and Request Memory:

``` shell
generator -pcpu "50m" -pmem "128Mi"
```

Configure Mimik Request Memory/CPU and Limit Memory/CPU:

``` shell
generator -lcpu "200m" -lmem "256Mi" -rcpu "25m" -rmem "64Mi"
```

Configure Replicas Numbers for Mimik:

``` shell
generator -replica 2
```